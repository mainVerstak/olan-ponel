(function(){define("search_location_module",["jquery","routes","area_on_map_module","search_on_map_module","extend_utils","livequery"],function(h,d,o,i){var r,c,s,l,t,p,u,m,f,v,e,a,n,g,_,y,C,b,k,x,L,S,q,j,w,D,T,M,A,F,P,z,I,N,J;return r={LIST:"list",MAP:"map"},w=null,p=function(t){return t.replace(/\+\d+$/,"")},f=function(t){var a,e,n,o,i,r,c,s,d,l,u,m,f;return f=[],h.each(t,function(t,e){if(0===h.grep(f,function(t){return h(t).attr("uid")===h(e).attr("uid")}).length)return f.push(e)}),t=f,t=h.grep(t,function(e){return 1===h.grep(t,function(t){return h(t).attr("uid")===h(e).attr("uid")}).length}),s=h.grep(t,function(e){return 0===h.grep(t,function(t){return h(t).attr("parent_id")===h(e).attr("uid")}).length}),0===(a=h.grep(t,function(t){return"sub_city"===h(t).attr("utype")})).length&&(a=h.grep(t,function(t){return"admin_area_with_city"===h(t).attr("utype")})),0===a.length&&(a=h.grep(t,function(t){return"city"===h(t).attr("utype")})),n=a,l=h.grep(s,function(e){return 0===h.grep(a,function(t){return h(t).attr("uid")===h(e).attr("uid")}).length}),l=h.map(l,function(e){return"address"===h(e).attr("utype")||"complex_address"===h(e).attr("utype")?[h.grep(t,function(t){return h(t).attr("uid")===h(e).attr("parent_id")}),e]:[e]}),l=[].concat.apply([],l),l=h.grep(l,function(t){return t}),e=h.map(n,function(t){return h(t).data("location")?p(h.trim(h(t).text())):h(t).hasClass("stationLink")?0<h(t).find("tspan").length&&h.map(h(t).find("tspan"),function(t){return p(h.trim(h(t).text()))}).join(" ")||p(h.trim(h(t).text())):h.trim(h(t).text())}),d=h.map(l,function(t){return h(t).data("location")?p(h.trim(h(t).text())):h(t).hasClass("stationLink")?0<h(t).find("tspan").length&&h.map(h(t).find("tspan"),function(t){return p(h.trim(h(t).text()))}).join(" ")||p(h.trim(h(t).text())):h.trim(h(t).text())}),i=e.concat(d),m=h.trim(i.join(", ")),c=w?"\u041e\u0431\u043b\u0430\u0441\u0442\u044c \u043d\u0430 \u043a\u0430\u0440\u0442\u0435":null,m=h.fn.compact([c,m]).join(": "),""===(m=h.fn.truncate(m,{length:38}))&&(m="\u0432\u044b\u0431\u0440\u0430\u0442\u044c"),1<s.length?(r="multi",o=h.unique(h.map(s,function(t){return h(t).attr("parent_id")}))[0]):(r="single",(u=null!=s?s[0]:void 0)&&(o=h(u).attr("uid"))),{title:m,id:o,locations:t,mod:r}},P=function(t){var e,a,n,o;return a=h.grep(h('[name="advertisement[offer_type][]"]:checked').map(function(){return h(this).val()}).get(),function(t){return t}).join(","),e=h.grep(h('[name="advertisement[category][]"]:checked').map(function(){return h(this).val()}).get(),function(t){return t}).join(","),o=h.grep(h('[name="advertisement[subcategory][]"]:checked').map(function(){return h(this).val()}).get(),function(t){return t}).join(","),n=h.grep(h('[name="advertisement[property_type][]"]:checked').map(function(){return h(this).val()}).get(),function(t){return t}).join(","),t.offer_types=a,t.categories=e,t.subcategories=o,t.property_types=n,t},v=function(){var t,e;return 0!==(t=(e=h("#form_search_locations_modal")).find(".search-button-locations-action-interlink.bold")).length?JSON.parse(t.attr("search_state")):JSON.parse(e.attr("state"))},h.each(["","garden_","cottage_"],function(t,a){return h('.type-filter-locations-action[utype="'+a+'street"]:not(.hidden):not(.loaded)').livequery(function(){var e,t;(e=h(this)).html('<div class="btn fas fa-spinner fa-spin"></div>'),t=v(),(t=P(t)).type=a+"street",t.sync=!0,h.getScript(d.locations.index(t),function(){var t;e.addClass("loaded"),e.find(".fa-spinner").remove(),t=h('[name="advertisement[location_ids][]"]'),f(t),h(".search-mod-changer-action").hasClass("active")&&(s('.type-filter-locations-action[utype="'+a+'street"] '),N(t))})})}),h('.type-filter-locations-action[utype="metro"]:not(.hidden):not(.loaded)').livequery(function(){var e,n;j(),(e=h(this)).html('<div class="btn fas fa-spinner fa-spin"></div>'),n=v(),(n=P(n)).type="metro",n.sync=!0,h(window).width()<=768?h.getScript(d.locations.index(n),function(){var t;e.addClass("loaded"),e.find(".fa-spinner").remove(),t=h('[name="advertisement[location_ids][]"]'),f(t),h(".search-mod-changer-action").hasClass("active")&&(s('.type-filter-locations-action[utype="metro"] '),N(t))}):h('.type-filter-locations-action[utype="metro"]').load(e.data("url"),function(){var a,t;0!==(a=h("#metro-schema")).length&&require(["panzoom"],function(t){var e;return(e=t(a[0],{maxZoom:2,minZoom:.5})).on("panstart",function(){return a.addClass("panning")}),e.on("panend",function(){var t;return t=null,t=setTimeout(function(){return a.removeClass("panning"),clearTimeout(t)},400)})}),t=h('[name="advertisement[location_ids][]"]'),f(t),l('.type-filter-locations-action[utype="metro"] ',n.id),h(".search-mod-changer-action").hasClass("active")?(s('.type-filter-locations-action[utype="metro"] '),N(t)):T('.type-filter-locations-action[utype="metro"] '),h.ajax({url:d.api.sections.index(),type:"GET",data:n,success:function(i){return h("#metro-schema .station-title").each(function(){var t,e,a,n,o;return t=(a=h(this)).closest("[data-location]"),0<(n=i[t.data("location")])?(0===(e=a.find("tspan:last")).length&&(e=a),e.text(e.text().trim()+"+"+n)):((o=h("#metro-schema").is(".faded"))&&t.addClass("recoverState"),o?void 0:t.addClass("noadv"))}),h(".stationLink").each(function(){var t,e,a,n;return t=h(this),0<(n=i[t.attr("uid")])?0<(a=t.find("tspan")).length?(e=a.last()).text(e.text()+"+"+n):t.text(t.text()+"+"+n):t.attr("style","opacity: 0.1;cursor: default; text-decoration: initial;")})},complete:function(){return e.addClass("loaded"),e.find(".fa-spinner").remove(),h('.type-filter-locations-action[utype="metro"]').find("svg").removeClass("hidden"),e.closest(".modal-content").trigger("resizeModal")}})})}),x=function(t){var e,a;return a=(e=h(this)).attr("utype"),t.preventDefault(),I(),h(".type-button-locations-action").removeClass("active"),e.addClass("active"),h(".type-filter-locations-action").addClass("hidden"),h(".type-filter-locations-action[utype="+a+"]").removeClass("hidden"),"metro"===a?j():M(),h("#form_search_locations_modal").trigger("locationTypeChanged")},C=function(t){var e,a;return e=h(this),t.preventDefault(),I(),a=v(),(a=P(a)).id=e.attr("uid"),a.sync=!0,h.getScript(d.locations.index(a),function(){if(0===h(".search-mod-changed-action").length)return u()})},T=function(){h("#svg-scene .active").each(function(){return h(this).removeClass("active")}),h("#metro-schema").removeClass("faded").find(".recoverState").removeClass("recoverState").addClass("noadv"),h(".search-mod-changed-action:not(.stationLink)").each(function(){var t;(t=h(this)).replaceWith('<a class="search-mod-changed-action search-button-locations-action" href="#" uid="'+t.attr("uid")+'" utype="'+t.attr("utype")+'" parent_id="'+t.attr("parent_id")+'"> '+t.text()+"</a>")}),h(".stationLink").each(function(){h(this).attr("class","stationLink search-mod-changed-action search-button-locations-action").closest("g").removeClass("select")}),J()},s=function(t){null==t&&(t=""),h(t+"#metro-schema").addClass("faded").find(".noadv").removeClass("noadv").addClass("recoverState"),h(t+".search-mod-changed-action:not(.stationLink)").each(function(){var t;(t=h(this)).replaceWith('<a class="doted search-mod-changed-action add-button-locations-action" href="#" uid="'+t.attr("uid")+'" utype="'+t.attr("utype")+'" parent_id="'+t.attr("parent_id")+'"><i class="far fa-square"></i> '+t.text()+"</a>")}),h(t+".stationLink").each(function(){h(this).attr("class","stationLink search-mod-changed-action add-button-locations-action")})},l=function(t,e){return null==t&&(t=""),h("#svg-scene g[data-location]").each(function(){var t;return(t=h(this)).attr("parent_id",e).attr("uid",t.data("location")).attr("utype","metro")}),h(t+".stationLink").each(function(){var t;(t=h(this)).attr("parent_id",e),t.attr("utype","metro")})},N=function(t){t.each(function(){var t,e,a,n;t=h(this),h("#svg-scene g[data-location='"+t.attr("uid")+"']").addClass("active"),n='.add-button-locations-action[uid="'+t.attr("uid")+'"]:not(.stationLink)',0<(e=h(n)).length&&(a=h(n+" i"),e.addClass("search-state-action"),a.removeClass("fa-square").addClass("fa-check-square")),n='.add-button-locations-action[uid="'+t.attr("uid")+'"].stationLink',0<(e=h(n)).length&&e.addClass("search-state-action").closest("g").addClass("select")}),J()},J=function(){0<h(".stationLink.search-state-action").length?h("#titles, #bg").addClass("select"):h("#titles, #bg").removeClass("select")},h(".search-mod-changer-action").livequery(function(){var e,t;if((e=h(this)).click(function(t){t.preventDefault(),e.hasClass("active")?(T(),e.removeClass("active")):(s(),e.addClass("active"))}),t=h('[name="advertisement[location_ids][]"]'),"multi"===f(t).mod)return e.addClass("active"),s(),void N(t)}),e=function(t){var e,a,n,o,i;return e=h(this),t.preventDefault(),o=e.find("i").hasClass("fa-check-square"),i='.add-button-locations-action[uid="'+e.attr("uid")+'"]',a=h(i),n=h(i+" i"),o?(a.removeClass("search-state-action"),n.removeClass("fa-check-square").addClass("fa-square")):(a.addClass("search-state-action"),n.removeClass("fa-square").addClass("fa-check-square"))},b=function(t){var e,a,n;return e=(a=h(this)).find(".stationLink"),t.preventDefault(),e.hasClass("add-button-locations-action")?(a.hasClass("select")?(e.removeClass("search-state-action"),a.removeAttr("class")):(e.addClass("search-state-action"),a.attr("class","select")),void J()):e.hasClass("search-button-locations-action")?(n=v(),(n=P(n)).id=e.attr("uid"),n.sync=!0,h.getScript(d.locations.index(n),function(){if(0===h(".search-mod-changed-action").length)return u()})):void 0},k=function(t){var e,a,n,o;if(!h("#metro-schema").hasClass("panning")&&(t.preventDefault(),n=h("#metro-schema").is(".faded"),!(e=h(this)).is(".noadv")||n))return a=e.data("location"),n?h("#metro-schema [data-location='"+a+"']").toggleClass("active"):(o=v(),(o=P(o)).id=a,o.sync=!0,h.getScript(d.locations.index(o),function(){if(0===h(".search-mod-changed-action").length)return u()}))},c=function(t,n){return t.each(function(t,e){var a;return a=h("#svg-scene g[data-location='"+h(e).data("location")+"']"),n?a.addClass("active"):a.removeClass("active")})},_=function(t){var e,a,n,o,i;if(!h("#metro-schema").hasClass("panning"))return t.preventDefault(),n=h(t.target),i=h("#metro-schema").is(".faded"),o=n.data("line"),a=h("#svg-scene g[data-location][id^=line"+o+"_]"),e=h("#svg-scene g.active[data-location][id^=line"+o+"_]"),i?c(a,e.length<a.length):(h(".search-mod-changer-action").trigger("click"),n.trigger("click"))},n=function(t){return t.preventDefault(),h("#form_search_locations_modal").modal("hide")},u=function(){var a,t,e,n;w=function(){switch(m()){case r.LIST:return null;case r.MAP:return o.getPolygon()}}(),h("#svg-scene .active").addClass("search-state-action"),e=h(".search-state-action"),t=f(e),h(".title-search-locations-action").text(t.title),h(".get-search-locations-action").removeClass("active").attr("uid",t.id),(a=h(".search_control_action")).html(""),w&&(n=h.fn.hiddenFieldTag("polygon",w.toString()),a.append(n)),h("#form_search_locations_modal").modal("hide"),h.each(t.locations,function(t,e){a.append('<input name="advertisement[location_ids][]" type="hidden" value="'+h(e).attr("uid")+'" uid="'+h(e).attr("uid")+'" utype="'+h(e).attr("utype")+'" parent_id="'+(h(e).attr("parent_id")||"")+'">')}),h.fn.isMobile()||(h.fn.isSearchMapMode()?i.refreshLocation():h(".search_form_action").find("[type=submit]:first").click())},A=function(){return h(".get-search-locations-action").attr("disabled","disabled")},F=function(){return h(".get-search-locations-action").removeAttr("disabled")},y=function(t){return t.preventDefault(),u()},h("input.autocomplete-search-location").livequery(function(){var s;s=h(this),require(["selectize"],function(){var r,c;r=function(t,e){return{id:t,type:e="street"===e?"address":"complex"===e?"complex_address":t?"street-landmark-non_admin_area-admin_area-cottage-garden-complex-metro":"region-district-direction-highway-city-sub_city"}},c=function(){var t,e,a,n,o,i;return 0===(t=(e=h("#form_search_locations_modal")).find(".search-button-locations-action-interlink.bold")).length?r(s.attr("parent_id"),s.attr("parent_type")):(i=h.map(e.find(".search-button-locations-action-interlink"),function(t){return h(t).attr("search_type")}),a=e.find(".search-button-locations-action-interlink").index(t),(o=i.slice(0,a)).includes("city")&&(n=t.attr("uid")),r(n,o.pop()))},s.selectize({plugins:["restore_on_backspace"],valueField:"value",labelField:"label",searchField:"label",create:!1,createFilter:function(t){var e;return(e=c()).id,"street"===e.type?1<=t.length:3<=t.length},onChange:function(t){var e;return e=v(),(e=P(e)).id=t,h.getScript(d.locations.index(e)),!0},load:function(t,e){var a,n,o,i;n=(o=c()).id,i=o.type,a=v(),(a=P(a)).id=n,a.term=t,a.type=i,h.ajax({url:d.api.sections.autocomlite(),type:"GET",data:a,error:function(){e()},success:function(t){e(t)}})}}),h(".autocomplete-search-location").removeClass("hidden"),h("#form_search_locations_modal").trigger("autocompleteLoaded")})}),g=function(t){var e,a,n;return e=h(this),t.preventDefault(),(a=P(a={})).id=e.attr("uid"),a.agency_id=h('[name="advertisement[agency_id]"]').val(),a.developer_id=h('[name="advertisement[developer_id]"]').val(),a.mode=h('[name="advertisement[mode]"]').val(),(n=h('[name="polygon"]').val())&&(w=D(n)),h.getScript(d.locations.index(a)),"undefined"!=typeof window&&null!==window?window.sendYandexMetrika("place_selector_press"):void 0},D=function(t){return h.fn.chunk(t.split(",").map(Number),2)},q=function(t){var e,a;return e=t.point,a=t.polygon,o.init({element:"area_map",point:e,polygon:a})},m=function(){return h("#area_map").hasClass("hidden")?r.LIST:r.MAP},j=function(){return h("#form_search_locations_modal > .modal-dialog").removeClass("modal-xl").addClass("modal-xxl")},M=function(){return h("#form_search_locations_modal > .modal-dialog").removeClass("modal-xxl").addClass("modal-xl")},z=function(){var t,e;if(m()!==r.MAP)return h("#form_search_locations_modal").addClass("modal-full-height"),t='<div class="map_loading"><i class="fas fa-spinner fa-spin" /></div>',h("#form_search_locations_modal .modal-body").prepend(t),h("#form_search_locations_modal .modal-body").addClass("for_map"),h("#location_list").addClass("hidden"),h("#area_map").removeClass("hidden"),h(".type-button-locations-action").removeClass("active"),h("#area_on_map_btn").addClass("active"),(e=v().id)?h.getJSON(d.api.locations.geocoding(e,{approximate:!0})).done(function(t){var e;return e=t.point,q({point:e,polygon:w})}).fail(function(){return q({polygon:w})}):q({polygon:w})},t=function(){return w=null,o.reset()},I=function(){if(t(),m()!==r.LIST)return h("#form_search_locations_modal").removeClass("modal-full-height"),h("#form_search_locations_modal .modal-body").removeClass("for_map"),h("#location_list").removeClass("hidden"),h("#area_map").addClass("hidden"),h("#area_on_map_btn").removeClass("active")},a=function(){return z()},S=function(){return w?z():I()},L=function(){return t()},h(document).on("click",".type-button-locations-action",x),h(document).on("click",".search-button-locations-action:not(.stationLink)",C),h(document).on("click",".add-button-locations-action:not(.stationLink)",e),h(document).on("click","g:has(>.stationLink)",b),h(document).on("click",".close-button-locations-action",n),h(document).on("click",".save-button-locations-action",y),h(document).on("click",".get-search-locations-action",g),h(document).on("click","#area_on_map_btn",a),h(document).on("show.bs.modal","#form_search_locations_modal",S),h(document).on("hidden.bs.modal","#form_search_locations_modal",L),h(document).on("ajax:beforeSend","form.search_form_action",A),h(document).on("ajax:complete","form.search_form_action",F),h(document).on("click touchend","#svg-scene g[data-location]",k),h(document).on("click touchend","#svg-legend path,#svg-legend text",_)})}).call(this);