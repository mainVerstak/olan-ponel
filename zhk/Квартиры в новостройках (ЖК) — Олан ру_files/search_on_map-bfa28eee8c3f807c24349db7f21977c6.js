(function(){define("search_on_map_module",["jquery","routes","humps","module","extend_utils","url_search_params_polyfill"],function($,routes,humps,module){var DEFAULT_CENTER,DEFAULT_ZOOM,FIXED_DIGITS,VIEWED_ADVERTISEMENTS_EXPIRE_AT,VIEWED_ADVERTISEMENTS_KEY,VIEWED_ADVERTISEMENTS_LIMIT,addPoint,advListModalHtml,counterControl,currentRequest,expireAdvertisementStorage,failMap,geocodingAndInitMap,geocodingCurrentLocation,getLocationId,getMapInitParamsFromQueryString,getSearchFormParams,getViewedAdvertisementsData,handleBoundschange,handleChangeMode,handleChangeSearchForm,handleClickCluster,handleClickItemsLoadMore,handleClickObject,handleClickPanelHider,initMap,isViewedAdvertisement,layer,loadList,localStorageSupported,locationId,map,markAsViewed,objectManager,panelControl,ready,refreshLayer,refreshLocation,refreshMap,refreshMapPoints,refreshing,renderAddSearchLinkBlock,showAdvListWithoutMapInModal,site;return site=module.config().site,DEFAULT_CENTER=[55.753215,37.622504],DEFAULT_ZOOM=12,FIXED_DIGITS=6,VIEWED_ADVERTISEMENTS_LIMIT=100,VIEWED_ADVERTISEMENTS_EXPIRE_AT=864e5,VIEWED_ADVERTISEMENTS_KEY="viewedAdvertisements",locationId=null,map=null,layer=null,objectManager=null,currentRequest=null,counterControl=null,panelControl=null,refreshing=!1,addPoint=function(e){var t,n,r,a;return t=e.id,n=e.latitude,r=e.longitude,a={},isViewedAdvertisement(t)&&(a.preset="islands#grayCircleDotIcon"),objectManager.add({type:"Feature",id:t,geometry:{type:"Point",coordinates:[n,r]},options:a})},getSearchFormParams=function(){return $("form.search_form_action").serializeArray().filter(function(e){return"utf8"!==e.name&&(""!==e.value||"advertisement[location_ids][]"===e.name)})},handleChangeSearchForm=function(){if($.fn.isSearchMapMode()&&!$.fn.isMobile())return refreshMap()},refreshMap=function(){var e;return objectManager.removeAll(),(e=getLocationId())&&locationId!==e&&refreshLocation(),refreshLayer(),refreshMapPoints({bounds:map.getBounds(),zoom:map.getZoom()})},refreshLayer=function(){if(layer)return layer.update()},refreshLocation=function(){return refreshing=!0,geocodingCurrentLocation(function(e){var t,n;return n=e.center,(t=e.bounds)?map.setBounds(t):map.setCenter(n)},function(){})},renderAddSearchLinkBlock=function(){return'<a class="add_search_link_action dot-link yaSend" href="#" rel="nofollow"\n  style="padding-left: 2px;line-height: 30px;" yaparam="save-search">\n  <i class="fas fa-search-plus"></i> \u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u043f\u043e\u0438\u0441\u043a\n</a>'},refreshMapPoints=function(arg){var bounds,data,zoom;return bounds=arg.bounds,zoom=arg.zoom,data=getSearchFormParams(),data.push({name:"bounds",value:bounds.toString()}),data.push({name:"zoom",value:zoom}),null!=counterControl&&counterControl.setLoading(),currentRequest&&currentRequest.abort(),currentRequest=$.getJSON(routes.advertisements.index(),data).done(function(e){var t,n,r,a,o,i,s,l,d,u,c,m,p,h,f;if($(".load_points_btn").blur(),d=(u=humps.camelizeKeys(e)).points,a=u.counter,c=u.request,t=u.showAddSearchLink?renderAddSearchLinkBlock():"",$(".add_search_link_block_action").html(t),f=c.url,m=c.queryString,h=c.title,n=$.fn.getQueryStringParam("advertisement_ids"),(p=new URLSearchParams(m))["delete"]("bounds"),p["delete"]("zoom"),r=map.getCenter().map(function(e){return Number(e.toFixed(FIXED_DIGITS))}),p.set("ll",r.toString()),p.set("z",map.getZoom()),n&&p.set("advertisement_ids",n),o=f+"?"+p,document.title=h,o!==document.location.href){if(Turbolinks.crossOriginUrl(o))return void(document.location.href=o);window.history.replaceState({turbolinks:!0,fullUrl:o},h,o)}for(objectManager.removeAll(),i=0,s=d.length;i<s;i++)l=d[i],addPoint(l);return null!=counterControl&&counterControl.updateCounter(a),refreshing=!1,refreshLayer()}).fail(function(jqXHR,textStatus,errorThrown){var doc,originalUrl,ref,ref1,responceHeader;if(responceHeader=null!=jqXHR?jqXHR.getResponseHeader("content-type"):void 0,-1<(null!=responceHeader?responceHeader.indexOf("javascript"):void 0))return eval(jqXHR.responseText);(doc=Turbolinks.processResponse(jqXHR))&&(originalUrl=(null!=(ref=doc.querySelector('meta[property="url"]'))&&"function"==typeof ref.getAttribute?ref.getAttribute("content"):void 0)||(null!=(ref1=doc.querySelector('meta[property="og:url"]'))&&"function"==typeof ref1.getAttribute?ref1.getAttribute("content"):void 0),originalUrl&&originalUrl!==document.location.href&&(document.location.href=originalUrl))})},handleBoundschange=function(e){var t,n;return t=e.get("newBounds"),n=e.get("newZoom"),refreshMapPoints({bounds:t,zoom:n})},advListModalHtml=function(){var e,t;return t=function(){return'<button type="button" class="close" data-dismiss="modal" aria-label="Close">\n  <span aria-hidden="true">&times;</span>\n</button>\n<h4 class="modal-title btn-link" data-dismiss="modal">\n  <i class="fas fa-chevron-left" />\n  <span>\u041d\u0430\u0437\u0430\u0434 \u043a \u043a\u0430\u0440\u0442\u0435</span>\n</h4>'},e=function(){return'<i class="fas fa-spinner fa-spin" />'},$.fn.generateModal({id:"adv_list_modal",size:"modal-full-height"},function(){return[$.fn.contentFuncTag("div",{"class":"modal-header"},t),$.fn.contentFuncTag("div",{"class":"modal-body"},e)].join("\n")})},handleClickObject=function(e){var t;return t=e.get("objectId"),objectManager.objects.setObjectOptions(t,{preset:"islands#grayCircleDotIcon"}),markAsViewed([t]),loadList([t])},loadList=function(i,e,s){var t;return null==e&&(e=1),null==s&&(s=!1),t={advertisement_ids:i.toString()},1!==e&&(t.page=e),$.fn.isMobile()&&!s&&($("#adv_list_modal").modal("hide").remove(),$.fn.assignModal(advListModalHtml()),$("#adv_list_modal").modal("show")),$.get(routes.advertisements.index(),t).done(function(e){var t,n,r,a,o;return $.fn.isMobile()?s?$("#adv_list_modal .modal-body").append(e):$("#adv_list_modal .modal-body").html(e):($(".map_panel").removeClass("map_panel_hidden"),panelControl.renderList(e,s)),t=(n=window.location).pathname,r=n.search,(a=new URLSearchParams(r)).set("advertisement_ids",i.toString()),o=t+"?"+a,window.history.replaceState({turbolinks:!0,url:o},document.title,o)})},handleClickCluster=function(e){var t,n;return n=e.get("objectId"),objectManager.clusters.setClusterOptions(n,{preset:"islands#grayClusterIcons"}),t=objectManager.clusters.getById(n).properties.geoObjects.map(function(e){return e.id}),loadList(t),markAsViewed(t)},markAsViewed=function(t){var e,n;if(localStorageSupported)return n=(n=(n=(n=(e=getViewedAdvertisementsData()).ids||[]).filter(function(e){return!t.includes(e)})).concat(t)).slice(Math.max(n.length-VIEWED_ADVERTISEMENTS_LIMIT,0)),e={date:(new Date).getTime(),ids:n},window.localStorage.setItem(VIEWED_ADVERTISEMENTS_KEY,JSON.stringify(e))},expireAdvertisementStorage=function(){var e;if(localStorageSupported)return e=getViewedAdvertisementsData(),(new Date).getTime()-e.date>VIEWED_ADVERTISEMENTS_EXPIRE_AT?window.localStorage.removeItem(VIEWED_ADVERTISEMENTS_KEY):void 0},localStorageSupported=function(){return"undefined"!=typeof Storage},getViewedAdvertisementsData=function(){var e;if(localStorageSupported)return(e=localStorage.getItem(VIEWED_ADVERTISEMENTS_KEY))?JSON.parse(e):{}},isViewedAdvertisement=function(e){if(localStorageSupported)return(getViewedAdvertisementsData().ids||[]).includes(e)},initMap=function(e){var t,n,r,a,o,i,s,l,d;return r=null!=(i=e.center)?i:DEFAULT_CENTER,d=null!=(s=e.zoom)?s:DEFAULT_ZOOM,t=e.bounds,map&&(null!=panelControl&&panelControl.moveSearchFormOut(),map.destroy()),o={center:r,zoom:d,bounds:t,controls:["zoomControl"]},map=new ymaps.Map("adv_map",o,{yandexMapDisablePoiInteractivity:!0,suppressMapOpenBlock:!0,minZoom:4}),a=$.fn.isMobile()?120:16,(objectManager=new ymaps.ObjectManager({clusterize:!0,gridSize:a,clusterDisableClickZoom:!0,clusterOpenBalloonOnClick:!1})).objects.options.set("preset","islands#greenCircleDotIcon"),objectManager.clusters.options.set("preset","islands#greenClusterIcons"),n=function(e){var t,n,r;for(r=t=0,n=e.length;t<n;)r+=e[t].weight,t++;return 17+2*Math.floor(Math.log(r))},objectManager.clusters.options.set("clusterIconLayout","default#pieChart"),objectManager.clusters.options.set("clusterIconPieChartCoreRadius",n),objectManager.objects.events.add("click",handleClickObject),objectManager.clusters.events.add("click",handleClickCluster),expireAdvertisementStorage(),map.geoObjects.add(objectManager),refreshMapPoints({bounds:map.getBounds(),zoom:map.getZoom()}),map.events.add("boundschange",$.fn.debounce(handleBoundschange,300)),l=function(e,t){var n,r,a,o;if(!refreshing)return r=e[0],a=e[1],o=t,(n=getSearchFormParams()).some(function(e){return"map"===e.name})||n.push({name:"map",value:"true"}),n.push({name:"x",value:r}),n.push({name:"y",value:a}),n.push({name:"z",value:o}),n.push({name:"format",value:"svg"}),routes.advertisements.index(n)},layer=new ymaps.Layer(l,{tileTransparent:!0,pane:"areas"}),map.copyrights.add("\xa9 "+site.domain),panelControl=new ymaps.Panel,map.controls.add(panelControl,{"float":"left"}),counterControl=new ymaps.Counter,map.controls.add(counterControl,{"float":"none",position:{bottom:30,right:10}}),window.setTimeout(function(){return map.layers.add(layer)},2e3)},handleChangeMode=function(){if($("#adv_map").length)return $("#adv_list_modal").modal("hide").remove(),geocodingAndInitMap()},getLocationId=function(){var e,t;return e=[],t=[],$('[name="advertisement[location_ids][]"]').each(function(){return e.push($(this).val()),t.push($(this).attr("parent_id"))}),$.fn.difference(e,t)[0]},geocodingCurrentLocation=function(r,e){return(locationId=getLocationId())?$.getJSON(routes.api.locations.geocoding(locationId,{approximate:!1})).done(function(e){var t,n;return t=e.bounds,n=e.point,r({center:n,bounds:t})}).fail(function(){return e()}):e()},geocodingAndInitMap=function(){var e;if(!(e=getMapInitParamsFromQueryString()))return geocodingCurrentLocation(initMap,function(){return initMap({})});initMap(e)},getMapInitParamsFromQueryString=function(){var e,t;if(e=$.fn.getQueryStringParam("ll"),t=$.fn.getQueryStringParam("z"),e&&t)try{return{center:e.split(",").map(Number),zoom:Number(t)}}catch(n){}},handleClickItemsLoadMore=function(){var e,t,n;return n=(e=$(this)).data("page"),t=e.data("advertisementIds"),loadList(t,n+1,!0),e.remove()},handleClickPanelHider=function(){return $(".map_panel").toggleClass("map_panel_hidden")},showAdvListWithoutMapInModal=function(){var e;return $.fn.assignModal(advListModalHtml()),e=$("#adv_list_without_map .map_panel_body").html(),$("#adv_list_modal .modal-body").html(e),$("#adv_list_modal").modal("show"),$("#adv_list_without_map").remove()},failMap=function(){return require(["bootstrap_notify"],function(){return $(".notifications").notify({message:{text:"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u042f\u043d\u0434\u0435\u043a\u0441.\u041a\u0430\u0440\u0442\u044b"},type:"danger"}).show()})},$(window).on("changeMode",handleChangeMode),$(document).on("click",".btn_items_load_more",handleClickItemsLoadMore),$(document).on("click",".map_panel_hider",handleClickPanelHider),ready=function(){if($("#adv_map").length)return $("#adv_list_without_map").length&&$.fn.isMobile()&&showAdvListWithoutMapInModal(),require(["ymaps","map_controls"],function(){return ymaps.ready(["Panel","Counter"]).then(geocodingAndInitMap)},function(e){if("ymaps"===(e.requireModules&&e.requireModules[0]))return failMap()})},$(document).ready(ready),$(document).on("page:load",ready),{refreshLocation:refreshLocation,refreshMap:refreshMap}}),define("map_controls",["ymaps"],function(){return ymaps.modules.define("Counter",["util.augment","collection.Item"],function(e,t,n){var r;return t(r=function(e){r.superclass.constructor.call(this,e),this._$content=null},n,{onAddToMap:function(e){return r.superclass.onAddToMap.call(this,e),this.getParent().getChildElement(this).then(this._onChildElementGet,this)},onRemoveFromMap:function(e){return this._$content&&this._$content.remove(),r.superclass.onRemoveFromMap.call(this,e)},_onChildElementGet:function(e){return this._$content=$('<div class="map_result_counter"></div>').appendTo(e)},setLoading:function(){var e;return e="\u041e\u0431\u043d\u043e\u0432\u043b\u044f\u0435\u0442\u0441\u044f...",this._$content.text(e),this.show()},failLoading:function(){var e;return e="\u0427\u0442\u043e-\u0442\u043e \u043f\u043e\u0448\u043b\u043e \u043d\u0435 \u0442\u0430\u043a.",this._$content.text(e),this.show()},updateCounter:function(e){var t,n,r;return t=e.quantity,r="\u041f\u043e\u043a\u0430\u0437\u0430\u043d\u043e "+(n=e.shown)+" \u0438\u0437 "+t+".",n<t&&(r+=" \u041f\u0440\u0438\u0431\u043b\u0438\u0437\u044c\u0442\u0435, \u0447\u0442\u043e\u0431\u044b \u0443\u0432\u0438\u0434\u0435\u0442\u044c \u0431\u043e\u043b\u044c\u0448\u0435."),this._$content.text(r),this.show()},hide:function(){return this._$content.css("display","none")},show:function(){return this._$content.css("display","block")}}),e(r)}),ymaps.modules.define("Panel",["util.augment","collection.Item"],function(e,t,n){var r;return t(r=function(e){r.superclass.constructor.call(this,e)},n,{onAddToMap:function(e){return r.superclass.onAddToMap.call(this,e),this.getParent().getChildElement(this).then(this._onGetChildElement,this)},onRemoveFromMap:function(e){return this._$panel&&this._$panel.remove(),r.superclass.onRemoveFromMap.call(this,e)},_onGetChildElement:function(e){var t;if(this._$panel=$('<div class="map_panel" />').appendTo(e),!$.fn.isMobile())return t=$("#adv_list_without_map .map_panel_body").html(),$.fn.getQueryStringParam("advertisement_ids")&&t?(this.renderList(t),$("#adv_list_without_map").remove()):this.renderFilters()},_handleClickToFilters:function(e){var t,n,r,a,o;return t=(n=window.location).pathname,r=n.search,(a=new URLSearchParams(r))["delete"]("advertisement_ids"),o=t+"?"+a,window.history.replaceState({turbolinks:!0,url:o},document.title,o),e.data.control.renderFilters()},_getSearchForm:function(){return $("form.search_form_action")},_renderHider:function(){return'<div class="map_panel_hider">\n  <i class="fas fa-chevron-left" />\n</div>'},moveSearchFormOut:function(){if(this._$panel.find("form.search_form_action").length)return $(".searchFormPage").append(this._getSearchForm())},renderFilters:function(){return this._$panel.html('<div class="map_panel_body" />\n'+this._renderHider()),this._$panel.find(".map_panel_body").append(this._getSearchForm())},renderList:function(e,t){return null==t&&(t=!1),this.moveSearchFormOut(),t?this._$panel.find(".map_panel_body").append(e):(this._$panel.html('<div class="map_panel_head">\n  <div class="to_filters_btn">\n    <i class="fas fa-chevron-left" />\n    <span>\u041d\u0430\u0437\u0430\u0434 \u043a \u0444\u0438\u043b\u044c\u0442\u0440\u0430\u043c</span>\n  </div>\n</div>\n<div class="map_panel_body">\n  '+e+"\n</div>"),$(".to_filters_btn").on("click",{control:this},this._handleClickToFilters))}}),e(r)})})}).call(this);